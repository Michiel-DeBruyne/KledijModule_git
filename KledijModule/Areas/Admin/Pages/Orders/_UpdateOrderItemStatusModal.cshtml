@* @using ProjectCore.Domain.Entities.Bestellingen
@model KledijModule.Areas.Admin.Pages.Orders.DetailsModel
@{
    ArgumentNullException.ThrowIfNull(Model);
}
<!-- Modal -->
<div id="my-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div id="modal-body" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <form id="myForm" method="post"
                      hx-post="@Url.Page("Details","Update")"
                      hx-swap="outerHTML">
                    <div class="mb-3">
                        <label asp-for="Data.OrderStatusValue" class="form-label">Update Status</label>
                        <select asp-for="Data.OrderStatusValue" class="form-control" placeholder="Status" asp-items="@Html.GetEnumSelectList<OrderStatus>()"></select>
                    </div>
                    @Html.AntiForgeryToken()
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button form="myForm"
                        type="submit"
                        class="btn btn-primary">
                    Save changes
                </button>
            </div>
        </div>
    </div>
</div>


 <script>
    document.body.addEventListener('htmx:beforeRequest', function (evt) {
        // Check if the event is triggered for the specific form
        console.log("beforrequest functie");
        var form = evt.detail.elt.closest('form#myForm');
        if (form) {
            // Select all checked checkboxes
            var selectedItems = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(function (checkbox) {
                return checkbox.value;
            });

            // Remove existing hidden inputs to avoid duplication
            form.querySelectorAll('input[name="Data.OrderItems"]').forEach(function (input) {
                input.remove();
            });

            // Add new hidden inputs for each selected item
            selectedItems.forEach(function (item) {
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'Data.OrderItems';
                hiddenInput.value = item;
                form.appendChild(hiddenInput);
            });

            console.log('Form before submission:', form.innerHTML);

            // Optionally, you could modify the request config, if needed:
            // evt.detail.requestConfig.headers['Custom-Header'] = 'YourValue';
        }
    });


    // Sluit de modal na een succesvolle HTMX request
    document.body.addEventListener('htmx:afterRequest', function (event) {
        const modalElement = document.getElementById('my-modal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);

        if (modalInstance) {
            modalInstance.hide();  // Sluit de modal
        }
    });
    function showModal() {
        const modal = new bootstrap.Modal('#my-modal');
        modal.show();
    }
    // scopes the modal so we can keep creating them
    showModal();
</script> *@
 



@using ProjectCore.Domain.Entities.Bestellingen
@model KledijModule.Areas.Admin.Pages.Orders.DetailsModel
@{
    ArgumentNullException.ThrowIfNull(Model);
}
<!-- Modal -->
<div id="my-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div id="modal-body" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="myForm" method="post" action="@Url.Page("Details", "Update")">
                    <div class="mb-3">
                        <label asp-for="Data.OrderStatusValue" class="form-label">Update Status</label>
                        <select asp-for="Data.OrderStatusValue" class="form-control" placeholder="Status"
                                asp-items="@Html.GetEnumSelectList<OrderStatus>()"></select>
                    </div>
                    @Html.AntiForgeryToken()
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="saveChangesButton" class="btn btn-primary">
                    Save changes
                </button>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function () {
        // Log een testbericht om te bevestigen dat het script geladen is
        console.log("test");

        // Handle form submission
        $('#saveChangesButton').on('click', function () {
            var form = $('#myForm');
            var selectedItems = $('input[type="checkbox"]:checked').map(function () {
                return $(this).val();
            }).get();

            // Verwijder bestaande verborgen inputs en voeg nieuwe toe
            form.find('input[name="selectedItems"]').remove();
            selectedItems.forEach(function (item) {
                $('<input>', {
                    type: 'hidden',
                    name: 'Data.OrderItems',
                    value: item
                }).appendTo(form);
            });

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function () {
                    var modal = bootstrap.Modal.getInstance('#my-modal');
                    if (modal) {
                        modal.hide(); // Sluit de modal
                    }
                    // Herlaad de pagina (optioneel)
                     window.location.reload();
                },
                error: function (jqXHR) {
                    // Verkrijg de foutmelding van de server
                    var errorMessage = jqXHR.responseText || 'Er is een fout opgetreden bij het bijwerken.';

                    // Toon de foutmelding in een alert
                    alert(errorMessage);
                }
            });
        });

        // Toon de modal bij het laden van de pagina
        new bootstrap.Modal('#my-modal').show();
    });
</script>
